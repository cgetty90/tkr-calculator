<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TKR 45-Point Calculator</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e8eef6; margin:0; padding:20px;}
    h1 { margin-top:0; }
    .card { background:#111826; border:1px solid #1f2a3a; border-radius:12px; padding:14px; margin-bottom:14px;}
    label { font-size:12px; opacity:.8; display:block; margin-bottom:4px;}
    input, select, button {
      width:100%; padding:8px; border-radius:8px;
      border:1px solid #243248; background:#0c1421; color:#e8eef6;
    }
    button { cursor:pointer; background:#13243d; }
    button:hover { background:#173056; }
    .grid { display:grid; gap:12px; }
    .grid-4 { grid-template-columns:1fr 1fr 1fr 1fr; }
    @media (max-width:900px){ .grid-4{grid-template-columns:1fr;} }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #2a3b55; background:#0c1421; font-size:12px; margin-right:6px;}
    .muted { opacity:.85; font-size:12px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #1f2a3a; padding:8px; text-align:left; }
    th { font-size:12px; opacity:.8; }
    .right { text-align:right; }
  </style>
</head>
<body>

<h1>TKR – 45 Point Calculator</h1>

<div class="card">
  <label>Rankings CSV (GitHub Pages)</label>
  <input id="csvUrl" value="rankings.csv"/>
  <div class="muted">CSV must contain columns: <b>name,rank</b> (header row required).</div>
</div>

<div class="card">
  <h3 style="margin-top:0;">Team Selection (4 players)</h3>
  <div class="grid grid-4">
    <div><label>Player 1</label><select id="p1"></select></div>
    <div><label>Player 2</label><select id="p2"></select></div>
    <div><label>Player 3</label><select id="p3"></select></div>
    <div><label>Player 4</label><select id="p4"></select></div>
  </div>
  <div style="margin-top:10px">
    <span class="pill">Team Rank: <b id="teamRank">–</b></span>
    <span class="pill">Divisor (0.1×rank): <b id="divisor">–</b></span>
  </div>
  <div class="muted" style="margin-top:8px;">
    Tip: you can choose <b>NONE</b> for any slot (rank counts as 0).
  </div>
</div>

<div class="card">
  <h3 style="margin-top:0;">Kills needed for 45-point game</h3>
  <div id="killsNeeded">Select players to calculate</div>
</div>

<div class="card">
  <h3 style="margin-top:0;">Games (max 4)</h3>
  <button onclick="addGame()">Add Game</button>
  <div id="games" style="margin-top:10px;"></div>
  <div style="margin-top:10px">
    <span class="pill">Total Points: <b id="totalPoints">0</b></span>
    <span class="pill">Remaining Possible: <b id="remainingPoints">180</b></span>
  </div>
</div>

<script>
const MAX_GAMES = 4;
const MULTIPLIER = 1;       // "1 point per kill" equivalent in your formula before scaling by divisor
const MAX_POINTS = 45;
const MILESTONES = [60,70,75,80,85,95,100];

let rankings = [];
let games = [];

function parseCSVLine(line){
  // Simple CSV splitter that supports quoted fields.
  const out = [];
  let cur = "";
  let inQ = false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"') {
      if (inQ && line[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      out.push(cur);
      cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out.map(s => s.trim());
}

async function loadCSV() {
  const baseUrl = document.getElementById("csvUrl").value.trim() || "rankings.csv";
  const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") + "ts=" + Date.now(); // cache-buster
  const text = await fetch(url).then(r=>r.text());

  const lines = text.replace(/\r/g,"").split("\n").filter(l => l.trim().length);
  if (!lines.length) throw new Error("CSV is empty");

  const headers = parseCSVLine(lines.shift()).map(h => h.toLowerCase());
  const nameIdx = headers.indexOf("name");
  const rankIdx = headers.indexOf("rank");
  if (nameIdx === -1 || rankIdx === -1) throw new Error("CSV must have headers: name,rank");

  rankings = lines.map(l=>{
    const cols = parseCSVLine(l);
    const name = cols[nameIdx] ?? "";
    const rank = parseFloat(cols[rankIdx] ?? "0");
    return { name, rank: isFinite(rank) ? rank : 0 };
  }).filter(r => r.name);

  // Sort names A->Z for nicer dropdowns
  rankings.sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:"base"}));

  fillPlayers();
}

function fillPlayers() {
  const ids = ["p1","p2","p3","p4"];
  ids.forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML="";
    // NONE option
    const none = document.createElement("option");
    none.value = "__NONE__";
    none.textContent = "NONE";
    s.appendChild(none);

    rankings.forEach(r=>{
      const o=document.createElement("option");
      o.value=r.name;
      o.textContent=r.name;
      s.appendChild(o);
    });
    s.onchange=updateTeam;
    s.value="__NONE__";
  });
  updateTeam();
}

function updateTeam() {
  const ids = ["p1","p2","p3","p4"];
  let rankSum = 0;

  ids.forEach(id=>{
    const val = document.getElementById(id).value;
    if (!val || val === "__NONE__") return;
    const r = rankings.find(x => x.name === val);
    if (r) rankSum += r.rank;
  });

  if (rankSum <= 0){
    document.getElementById("teamRank").textContent="–";
    document.getElementById("divisor").textContent="–";
    document.getElementById("killsNeeded").textContent="Select players to calculate";
    recalc();
    return;
  }

  document.getElementById("teamRank").textContent=rankSum.toFixed(2);
  document.getElementById("divisor").textContent=(rankSum*0.1).toFixed(2);
  calcKillsNeeded(rankSum);
  recalc();
}

function milestonePoints(kills){
  return MILESTONES.filter(m=>kills>=m).length;
}

function calcKillsNeeded(rank){
  const div = rank*0.1;
  let kills=0;
  while(true){
    const ptsRaw = (kills*MULTIPLIER/div) + milestonePoints(kills);
    if(ptsRaw>=MAX_POINTS){
      document.getElementById("killsNeeded").innerHTML =
        `<b>${kills}</b> kills needed for a <b>45-point</b> game (before capping, milestones included).`;
      return;
    }
    kills++;
    // safety guard (in case rank is extremely large)
    if (kills > 2000){
      document.getElementById("killsNeeded").textContent = "Rank too high to reach 45 points within 2000 kills.";
      return;
    }
  }
}

function addGame(){
  if(games.length>=MAX_GAMES) return;
  games.push({kills:0, points:0});
  renderGames();
  recalc();
}

function renderGames(){
  const gDiv=document.getElementById("games");
  gDiv.innerHTML="";
  games.forEach((g,i)=>{
    const d=document.createElement("div");
    d.className="card";
    d.style.marginBottom="10px";
    d.innerHTML=`
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:700;">Game ${i+1}</div>
        <button class="inlineBtn" style="width:auto;" onclick="removeGame(${i})">Remove</button>
      </div>
      <div style="margin-top:10px;">
        <label>Total team kills (all 4 players combined)</label>
        <input type="number" min="0" value="${g.kills}"
          onchange="updateGame(${i},this.value)">
      </div>
      <div style="margin-top:8px;" class="muted">
        Milestone points: <b>${milestonePoints(g.kills)}</b>
        &nbsp;|&nbsp; Game points: <b>${g.points.toFixed(2)}</b> (capped at 45)
      </div>
    `;
    gDiv.appendChild(d);
  });
}

function removeGame(i){
  games.splice(i,1);
  renderGames();
  recalc();
}

function updateGame(i,val){
  games[i].kills = Math.max(0, parseInt(val||0, 10));
  recalc();
}

function recalc(){
  const rankTxt=document.getElementById("teamRank").textContent;
  let total=0;
  if(rankTxt !== "–"){
    const rank=parseFloat(rankTxt);
    const div=rank*0.1;
    games.forEach(g=>{
      const ptsRaw=(g.kills*MULTIPLIER/div) + milestonePoints(g.kills);
      g.points=Math.min(MAX_POINTS, ptsRaw);
      total += g.points;
    });
  } else {
    games.forEach(g=>g.points=0);
  }

  document.getElementById("totalPoints").textContent=total.toFixed(2);
  document.getElementById("remainingPoints").textContent=(MAX_POINTS*(MAX_GAMES-games.length)).toFixed(0);
  renderGames();
}

// Reload CSV when URL changes (and on Enter)
document.getElementById("csvUrl").addEventListener("change", () => loadCSV().catch(e=>alert(e.message)));
document.getElementById("csvUrl").addEventListener("keydown", (e) => {
  if (e.key === "Enter") loadCSV().catch(err=>alert(err.message));
});

loadCSV().catch(e=>alert(e.message));
</script>
</body>
</html>
