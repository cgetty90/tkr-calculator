<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TKR 45-Point Calculator</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e8eef6; margin:0; padding:20px;}
    h1 { margin-top:0; }
    .card { background:#111826; border:1px solid #1f2a3a; border-radius:12px; padding:14px; margin-bottom:14px;}
    label { font-size:12px; opacity:.8; display:block; margin-bottom:4px;}
    input, select, button {
      width:100%; padding:8px; border-radius:8px;
      border:1px solid #243248; background:#0c1421; color:#e8eef6;
    }
    button { cursor:pointer; background:#13243d; }
    button:hover { background:#173056; }
    .grid { display:grid; gap:12px; }
    .grid-4 { grid-template-columns:1fr 1fr 1fr 1fr; }
    .grid-2 { grid-template-columns:1fr 1fr; }
    @media (max-width:900px){ .grid-4{grid-template-columns:1fr;} .grid-2{grid-template-columns:1fr;} }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #2a3b55; background:#0c1421; font-size:12px; margin-right:6px;}
    .muted { opacity:.85; font-size:12px; }
    .row { display:flex; gap:10px; align-items:end; }
    .row > * { flex: 1; }
  </style>
</head>
<body>

<h1>TKR – 45 Point Calculator</h1>

<div class="card">
  <h3 style="margin-top:0;">Team Selection (4 players)</h3>
  <div class="grid grid-4">
    <div><label>Player 1</label><select id="p1"></select></div>
    <div><label>Player 2</label><select id="p2"></select></div>
    <div><label>Player 3</label><select id="p3"></select></div>
    <div><label>Player 4</label><select id="p4"></select></div>
  </div>
  <div style="margin-top:10px">
    <span class="pill">Team Rank: <b id="teamRank">–</b></span>
    <span class="pill">Real players: <b id="realPlayers">0</b></span>
    <span class="pill">Divisor (0.1×rank): <b id="divisor">–</b></span>
  </div>
  <div class="muted" style="margin-top:8px;">
    Choose <b>NONE</b> for any slot (rank counts as 0). If you have exactly <b>3 real players</b> (one NONE), the app adds <b>+0.15</b> to each placement multiplier.
  </div>
</div>

<div class="card">
  <h3 style="margin-top:0;">Kills needed for a 45-point game</h3>
  <div class="grid grid-2" style="margin-bottom:10px;">
    <div>
      <label>Assumed placement</label>
      <select id="assumedPlacement"></select>
    </div>
    <div>
      <label>Milestones</label>
      <input id="milestonesLabel" disabled/>
    </div>
  </div>
  <div id="killsNeeded">Select players to calculate</div>
</div>

<div class="card">
  <h3 style="margin-top:0;">Games (max 4)</h3>
  <button onclick="addGame()">Add Game</button>
  <div id="games" style="margin-top:10px;"></div>
  <div style="margin-top:10px">
    <span class="pill">Total Points: <b id="totalPoints">0</b></span>
    <span class="pill">Remaining Possible: <b id="remainingPoints">180</b></span>
  </div>
</div>

<script>
const MAX_GAMES = 4;
const MAX_POINTS = 45;

// Win multipliers (4 players)
const PLACEMENTS = [
  { key: "1st",      label: "1st",      base: 2.25 },
  { key: "2nd-3rd",  label: "2nd–3rd",  base: 1.50 },
  { key: "4th-5th",  label: "4th–5th",  base: 1.25 },
  { key: "6th-10th", label: "6th–10th", base: 1.00 },
  { key: "11th+",    label: "11th+",    base: 0.75 },
];

// Milestones add +1 point each when total team kills reaches the threshold
const MILESTONES = [60,70,75,80,85,95,100];

let rankings = [];
let games = [];

function milestonePoints(kills){
  return MILESTONES.filter(m=>kills>=m).length;
}

function placementMulti(placementKey, realPlayers){
  const p = PLACEMENTS.find(x => x.key === placementKey) || PLACEMENTS[0];
  // For 3 real players (one NONE selected), add +0.15 to each placement multiplier
  const bonus = (realPlayers === 3) ? 0.15 : 0.0;
  return p.base + bonus;
}

function parseCSVLine(line){
  // Simple CSV splitter that supports quoted fields.
  const out = [];
  let cur = "";
  let inQ = false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"') {
      if (inQ && line[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      out.push(cur);
      cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out.map(s => s.trim());
}

async function loadCSV() {
  // GitHub Pages: keep rankings.csv in the same repo root as index.html
  const url = "rankings.csv?ts=" + Date.now(); // cache-buster to avoid stale CSV
  const text = await fetch(url).then(r=>r.text());

  const lines = text.replace(/\r/g,"").split("\n").filter(l => l.trim().length);
  if (!lines.length) throw new Error("rankings.csv is empty");

  const headers = parseCSVLine(lines.shift()).map(h => h.toLowerCase());
  const nameIdx = headers.indexOf("name");
  const rankIdx = headers.indexOf("rank");
  if (nameIdx === -1 || rankIdx === -1) throw new Error("rankings.csv must have headers: name,rank");

  rankings = lines.map(l=>{
    const cols = parseCSVLine(l);
    const name = cols[nameIdx] ?? "";
    const rank = parseFloat(cols[rankIdx] ?? "0");
    return { name, rank: isFinite(rank) ? rank : 0 };
  }).filter(r => r.name);

  rankings.sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:"base"}));

  fillPlayers();
  fillPlacements();
  document.getElementById("milestonesLabel").value = MILESTONES.join(", ");
}

function fillPlacements(){
  const s = document.getElementById("assumedPlacement");
  s.innerHTML = "";
  PLACEMENTS.forEach(p=>{
    const o = document.createElement("option");
    o.value = p.key;
    o.textContent = p.label;
    s.appendChild(o);
  });
  s.value = "1st";
  s.onchange = () => updateTeam();
}

function fillPlayers() {
  const ids = ["p1","p2","p3","p4"];
  ids.forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML="";
    const none = document.createElement("option");
    none.value = "__NONE__";
    none.textContent = "NONE";
    s.appendChild(none);

    rankings.forEach(r=>{
      const o=document.createElement("option");
      o.value=r.name;
      o.textContent=r.name;
      s.appendChild(o);
    });

    s.onchange=updateTeam;
    s.value="__NONE__";
  });
  updateTeam();
}

function updateTeam() {
  const ids = ["p1","p2","p3","p4"];
  let rankSum = 0;
  let realPlayers = 0;

  ids.forEach(id=>{
    const val = document.getElementById(id).value;
    if (!val || val === "__NONE__") return;
    const r = rankings.find(x => x.name === val);
    if (r) {
      rankSum += r.rank;
      realPlayers += 1;
    }
  });

  document.getElementById("realPlayers").textContent = String(realPlayers);

  if (rankSum <= 0){
    document.getElementById("teamRank").textContent="–";
    document.getElementById("divisor").textContent="–";
    document.getElementById("killsNeeded").textContent="Select players to calculate";
    recalc();
    return;
  }

  document.getElementById("teamRank").textContent=rankSum.toFixed(2);
  document.getElementById("divisor").textContent=(rankSum*0.1).toFixed(2);

  calcKillsNeeded(rankSum, realPlayers);
  recalc();
}

function gamePointsFromKills(kills, placementKey, teamRank, realPlayers){
  const div = teamRank * 0.1;
  const multi = placementMulti(placementKey, realPlayers);
  const raw = (kills * multi / div) + milestonePoints(kills);
  return Math.min(MAX_POINTS, raw);
}

function calcKillsNeeded(teamRank, realPlayers){
  const placementKey = document.getElementById("assumedPlacement").value || "1st";

  let kills = 0;
  // Find the first integer kill count that reaches 45 (before capping, milestones included)
  while (kills <= 2000){
    const pts = gamePointsFromKills(kills, placementKey, teamRank, realPlayers);
    if (pts >= MAX_POINTS){
      const multi = placementMulti(placementKey, realPlayers);
      const div = teamRank*0.1;
      document.getElementById("killsNeeded").innerHTML =
        `<b>${kills}</b> kills needed for a <b>45-point</b> game as <b>${PLACEMENTS.find(p=>p.key===placementKey)?.label || placementKey}</b>.
         <div class="muted" style="margin-top:6px;">
           (Using multiplier <b>${multi.toFixed(2)}</b>, divisor <b>${div.toFixed(2)}</b>, plus milestone points.)
         </div>`;
      return;
    }
    kills++;
  }
  document.getElementById("killsNeeded").textContent = "Unable to reach 45 points within 2000 kills (check ranks).";
}

function addGame(){
  if (games.length >= MAX_GAMES) return;
  games.push({ kills: 0, placement: "1st", points: 0 });
  renderGames();
  recalc();
}

function removeGame(i){
  games.splice(i,1);
  renderGames();
  recalc();
}

function updateGameKills(i, val){
  games[i].kills = Math.max(0, parseInt(val||0, 10));
  recalc();
}

function updateGamePlacement(i, val){
  games[i].placement = val;
  recalc();
}

function renderGames(){
  const gDiv = document.getElementById("games");
  gDiv.innerHTML = "";
  games.forEach((g,i)=>{
    const d = document.createElement("div");
    d.className = "card";
    d.style.marginBottom = "10px";

    const placementOptions = PLACEMENTS.map(p => {
      const sel = (p.key === g.placement) ? "selected" : "";
      return `<option value="${p.key}" ${sel}>${p.label}</option>`;
    }).join("");

    d.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:700;">Game ${i+1}</div>
        <button style="width:auto;" onclick="removeGame(${i})">Remove</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Total team kills (combined)</label>
          <input type="number" min="0" value="${g.kills}" onchange="updateGameKills(${i}, this.value)">
        </div>
        <div>
          <label>Placement</label>
          <select onchange="updateGamePlacement(${i}, this.value)">${placementOptions}</select>
        </div>
      </div>

      <div class="muted" style="margin-top:8px;">
        Milestone points: <b>${milestonePoints(g.kills)}</b>
        &nbsp;|&nbsp; Game points: <b>${g.points.toFixed(2)}</b> (capped at 45)
      </div>
    `;
    gDiv.appendChild(d);
  });
}

function recalc(){
  const rankTxt = document.getElementById("teamRank").textContent;
  const realPlayers = parseInt(document.getElementById("realPlayers").textContent || "0", 10);

  let total = 0;

  if (rankTxt !== "–"){
    const teamRank = parseFloat(rankTxt);
    games.forEach(g=>{
      g.points = gamePointsFromKills(g.kills, g.placement, teamRank, realPlayers);
      total += g.points;
    });
  } else {
    games.forEach(g=>g.points = 0);
  }

  document.getElementById("totalPoints").textContent = total.toFixed(2);
  document.getElementById("remainingPoints").textContent = String(MAX_POINTS * (MAX_GAMES - games.length));
  renderGames();
}

loadCSV().catch(e=>alert(e.message));
</script>
</body>
</html>
