<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TKR 45-Point Calculator</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e8eef6; margin:0; padding:20px;}
    h1 { margin-top:0; }
    .card { background:#111826; border:1px solid #1f2a3a; border-radius:12px; padding:14px; margin-bottom:14px;}
    label { font-size:12px; opacity:.8; display:block; margin-bottom:4px;}
    input, select, button {
      width:100%; padding:8px; border-radius:8px;
      border:1px solid #243248; background:#0c1421; color:#e8eef6;
    }
    button { cursor:pointer; background:#13243d; }
    button:hover { background:#173056; }
    .grid { display:grid; gap:12px; }
    .grid-4 { grid-template-columns:1fr 1fr 1fr 1fr; }
    .grid-2 { grid-template-columns:1fr 1fr; }
    @media (max-width:900px){ .grid-4{grid-template-columns:1fr;} .grid-2{grid-template-columns:1fr;} }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #2a3b55; background:#0c1421; font-size:12px; margin-right:6px; margin-top:6px;}
    .muted { opacity:.85; font-size:12px; }
    .row { display:flex; gap:10px; align-items:end; }
    .row > * { flex: 1; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #1f2a3a; padding:8px; text-align:left; font-size:13px;}
    th { font-size:12px; opacity:.8; }
    .right { text-align:right; }
  </style>
</head>
<body>

<h1>TKR – 45 Point Calculator</h1>

<div class="card">
  <h3 style="margin-top:0;">Team Selection (4 slots)</h3>
  <div class="grid grid-4">
    <div><label>Player 1</label><select id="p1"></select></div>
    <div><label>Player 2</label><select id="p2"></select></div>
    <div><label>Player 3</label><select id="p3"></select></div>
    <div><label>Player 4</label><select id="p4"></select></div>
  </div>

  <div id="rankBreakdown" style="margin-top:12px;"></div>

  <div style="margin-top:10px">
    <span class="pill">Team Rank: <b id="teamRank">–</b></span>
    <span class="pill">Real players: <b id="realPlayers">0</b></span>
    <span class="pill">Divisor (0.1×rank): <b id="divisor">–</b></span>
  </div>

  <div class="muted" style="margin-top:8px;">
    Choose <b>NONE</b> for any slot (rank counts as 0). If you have exactly <b>3 real players</b> (one NONE), the app adds <b>+0.15</b> to every placement multiplier.
  </div>
</div>

<div class="card">
  <h3 style="margin-top:0;">Kills needed</h3>

  <div class="grid grid-2" style="margin-bottom:10px;">
    <!-- Left: assumed placement + milestones under it -->
    <div>
      <label>Assumed placement</label>
      <select id="assumedPlacement"></select>

      <div style="height:10px;"></div>
      <label>Milestones (+1 each)</label>
      <input id="milestonesLabel" disabled/>
    </div>

    <!-- Right: target score -->
    <div>
      <label>Target total score (all games)</label>
      <input id="targetTotal" type="number" min="0" step="0.01" value="180"/>
      <div class="muted" style="margin-top:6px;">
        Max games: <b>4</b> (so target per-game = target/4). Max points per game = <b>45</b>.
      </div>
    </div>
  </div>

  <div id="killsNeeded45" style="margin-bottom:10px;">Select players to calculate</div>
  <div id="killsNeededTarget">—</div>
</div>

<div class="card">
  <h3 style="margin-top:0;">Games (max 4)</h3>
  <button onclick="addGame()">Add Game</button>
  <div id="games" style="margin-top:10px;"></div>
  <div style="margin-top:10px">
    <span class="pill">Total Points: <b id="totalPoints">0</b></span>
    <span class="pill">Remaining Possible: <b id="remainingPoints">180</b></span>
  </div>
</div>

<script>
const MAX_GAMES = 4;
const MAX_POINTS = 45;

// Placement multipliers for 4 real players
const PLACEMENTS = [
  { key: "1st",      label: "1st",      base: 2.25 },
  { key: "2nd-3rd",  label: "2nd–3rd",  base: 1.50 },
  { key: "4th-5th",  label: "4th–5th",  base: 1.25 },
  { key: "6th-10th", label: "6th–10th", base: 1.00 },
  { key: "11th+",    label: "11th+",    base: 0.75 },
];

// Milestones add +1 point each when total team kills reaches the threshold
const MILESTONES = [60,70,75,80,85,95,100];

let rankings = [];
let rankByName = new Map();
let games = [];

function milestonePoints(kills){
  return MILESTONES.filter(m=>kills>=m).length;
}

function placementMulti(placementKey, realPlayers){
  const p = PLACEMENTS.find(x => x.key === placementKey) || PLACEMENTS[0];
  const trioBonus = (realPlayers === 3) ? 0.15 : 0.0;
  return p.base + trioBonus;
}

function parseCSVLine(line){
  const out = [];
  let cur = "";
  let inQ = false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"') {
      if (inQ && line[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      out.push(cur);
      cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out.map(s => s.trim());
}

async function loadCSV() {
  const url = "rankings.csv?ts=" + Date.now();
  const text = await fetch(url, { cache: "no-store" }).then(r=>r.text());

  const lines = text.replace(/\r/g,"").split("\n").filter(l => l.trim().length);
  if (!lines.length) throw new Error("rankings.csv is empty");

  const headers = parseCSVLine(lines.shift()).map(h => h.toLowerCase());
  const nameIdx = headers.indexOf("name");
  const rankIdx = headers.indexOf("rank");
  if (nameIdx === -1 || rankIdx === -1) throw new Error("rankings.csv must have headers: name,rank");

  rankings = [];
  rankByName = new Map();

  lines.forEach(l=>{
    const cols = parseCSVLine(l);
    const nameRaw = cols[nameIdx] ?? "";
    const rankRaw = cols[rankIdx] ?? "0";
    const name = String(nameRaw).trim();
    const rank = parseFloat(String(rankRaw).trim());
    if (!name) return;
    const r = { name, rank: (isFinite(rank) ? rank : 0) };
    rankings.push(r);
    // If duplicates exist, last one wins.
    rankByName.set(name, r.rank);
  });

  rankings.sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:"base"}));

  fillPlayers();
  fillPlacements();
  document.getElementById("milestonesLabel").value = MILESTONES.join(", ");
}

function fillPlacements(){
  const s = document.getElementById("assumedPlacement");
  s.innerHTML = "";
  PLACEMENTS.forEach(p=>{
    const o = document.createElement("option");
    o.value = p.key;
    o.textContent = p.label;
    s.appendChild(o);
  });
  s.value = "1st";
  s.onchange = () => updateTeam();
}

function fillPlayers() {
  const ids = ["p1","p2","p3","p4"];
  ids.forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML="";
    const none = document.createElement("option");
    none.value = "__NONE__";
    none.textContent = "NONE";
    s.appendChild(none);

    rankings.forEach(r=>{
      const o=document.createElement("option");
      o.value=r.name;
      o.textContent=r.name;
      s.appendChild(o);
    });

    s.onchange=updateTeam;
    s.value="__NONE__";
  });
  updateTeam();
}

function computeTeam(){
  const ids = ["p1","p2","p3","p4"];
  let teamRank = 0;
  let realPlayers = 0;
  const breakdown = [];

  ids.forEach(id=>{
    const name = document.getElementById(id).value;
    if (!name || name === "__NONE__"){
      breakdown.push({ name: "NONE", rank: 0 });
      return;
    }
    const rank = rankByName.get(name) ?? 0;
    breakdown.push({ name, rank });
    teamRank += rank;
    realPlayers += 1;
  });

  return { teamRank, realPlayers, breakdown };
}

function renderBreakdown(breakdown){
  const rows = breakdown.map(b => `
    <tr>
      <td>${escapeHtml(b.name)}</td>
      <td class="right">${Number(b.rank).toFixed(2)}</td>
    </tr>
  `).join("");

  document.getElementById("rankBreakdown").innerHTML = `
    <table>
      <thead><tr><th>Player</th><th class="right">Rank</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function gamePointsFromKills(kills, placementKey, teamRank, realPlayers){
  const div = teamRank * 0.1;
  const multi = placementMulti(placementKey, realPlayers);
  const raw = (kills * multi / div) + milestonePoints(kills);
  return Math.min(MAX_POINTS, raw);
}

function minKillsForTarget(perGameTarget, placementKey, teamRank, realPlayers){
  if (perGameTarget <= 0) return 0;
  if (perGameTarget > MAX_POINTS) return null; // impossible because game is capped
  let kills = 0;
  while (kills <= 5000){
    const pts = gamePointsFromKills(kills, placementKey, teamRank, realPlayers);
    if (pts >= perGameTarget) return kills;
    kills++;
  }
  return null;
}

function updateTeam() {
  const { teamRank, realPlayers, breakdown } = computeTeam();
  renderBreakdown(breakdown);

  document.getElementById("realPlayers").textContent = String(realPlayers);

  if (teamRank <= 0){
    document.getElementById("teamRank").textContent="–";
    document.getElementById("divisor").textContent="–";
    document.getElementById("killsNeeded45").textContent="Select players to calculate";
    document.getElementById("killsNeededTarget").textContent="—";
    recalc();
    return;
  }

  document.getElementById("teamRank").textContent = teamRank.toFixed(2);
  document.getElementById("divisor").textContent = (teamRank*0.1).toFixed(2);

  calcKillsNeededBlocks(teamRank, realPlayers);
  recalc();
}

function calcKillsNeededBlocks(teamRank, realPlayers){
  const placementKey = document.getElementById("assumedPlacement").value || "1st";
  const placementLabel = PLACEMENTS.find(p=>p.key===placementKey)?.label || placementKey;

  // 45-point max game
  const k45 = minKillsForTarget(45, placementKey, teamRank, realPlayers);
  const multi = placementMulti(placementKey, realPlayers);
  const div = teamRank*0.1;

  document.getElementById("killsNeeded45").innerHTML =
    `<b>${k45 ?? "—"}</b> kills needed for a <b>45-point</b> game as <b>${placementLabel}</b>.
     <div class="muted" style="margin-top:6px;">
       (Multiplier <b>${multi.toFixed(2)}</b>, divisor <b>${div.toFixed(2)}</b>, milestones included, capped at 45)
     </div>`;

  // Target total score across all games
  const targetTotal = parseFloat(document.getElementById("targetTotal").value || "0");
  const perGameTarget = targetTotal / MAX_GAMES;

  if (!isFinite(targetTotal) || targetTotal < 0){
    document.getElementById("killsNeededTarget").innerHTML = `<span class="muted">Enter a valid target total.</span>`;
    return;
  }

  if (perGameTarget > MAX_POINTS){
    document.getElementById("killsNeededTarget").innerHTML =
      `<span class="muted">Target total <b>${targetTotal.toFixed(2)}</b> implies <b>${perGameTarget.toFixed(2)}</b> points/game, but max is <b>45</b>.</span>`;
    return;
  }

  const kTarget = minKillsForTarget(perGameTarget, placementKey, teamRank, realPlayers);
  document.getElementById("killsNeededTarget").innerHTML =
    `<b>${kTarget ?? "—"}</b> kills/game to average <b>${perGameTarget.toFixed(2)}</b> points/game (target total <b>${targetTotal.toFixed(2)}</b> over ${MAX_GAMES} games), as <b>${placementLabel}</b>.`;
}

function addGame(){
  if (games.length >= MAX_GAMES) return;
  games.push({ kills: 0, placement: "1st", points: 0 });
  renderGames();
  recalc();
}

function removeGame(i){
  games.splice(i,1);
  renderGames();
  recalc();
}

function updateGameKills(i, val){
  games[i].kills = Math.max(0, parseInt(val||0, 10));
  recalc();
}

function updateGamePlacement(i, val){
  games[i].placement = val;
  recalc();
}

function renderGames(){
  const gDiv = document.getElementById("games");
  gDiv.innerHTML = "";
  games.forEach((g,i)=>{
    const d = document.createElement("div");
    d.className = "card";
    d.style.marginBottom = "10px";

    const placementOptions = PLACEMENTS.map(p => {
      const sel = (p.key === g.placement) ? "selected" : "";
      return `<option value="${p.key}" ${sel}>${p.label}</option>`;
    }).join("");

    d.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:700;">Game ${i+1}</div>
        <button style="width:auto;" onclick="removeGame(${i})">Remove</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Total team kills (combined)</label>
          <input type="number" min="0" value="${g.kills}" onchange="updateGameKills(${i}, this.value)">
        </div>
        <div>
          <label>Placement</label>
          <select onchange="updateGamePlacement(${i}, this.value)">${placementOptions}</select>
        </div>
      </div>

      <div class="muted" style="margin-top:8px;">
        Milestone points: <b>${milestonePoints(g.kills)}</b>
        &nbsp;|&nbsp; Game points: <b>${g.points.toFixed(2)}</b> (capped at 45)
      </div>
    `;
    gDiv.appendChild(d);
  });
}

function recalc(){
  const rankTxt = document.getElementById("teamRank").textContent;
  const realPlayers = parseInt(document.getElementById("realPlayers").textContent || "0", 10);
  let total = 0;

  if (rankTxt !== "–"){
    const teamRank = parseFloat(rankTxt);
    games.forEach(g=>{
      g.points = gamePointsFromKills(g.kills, g.placement, teamRank, realPlayers);
      total += g.points;
    });
  } else {
    games.forEach(g=>g.points = 0);
  }

  document.getElementById("totalPoints").textContent = total.toFixed(2);
  document.getElementById("remainingPoints").textContent = String(MAX_POINTS * (MAX_GAMES - games.length));
  renderGames();

  // Also update kills-needed blocks when games change? Not needed, but when ranks/placement/target changes, yes.
}

document.getElementById("targetTotal").addEventListener("input", () => {
  const rankTxt = document.getElementById("teamRank").textContent;
  const realPlayers = parseInt(document.getElementById("realPlayers").textContent || "0", 10);
  if (rankTxt !== "–"){
    calcKillsNeededBlocks(parseFloat(rankTxt), realPlayers);
  }
});

loadCSV().catch(e=>alert(e.message));
</script>
</body>
</html>
